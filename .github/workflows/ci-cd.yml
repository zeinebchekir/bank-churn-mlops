name: CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # ‚ö†Ô∏è REMPLACEZ CES VALEURS PAR LES V√îTRES ‚ö†Ô∏è
  AZURE_RESOURCE_GROUP: rg-mlops-bank-churn-italy
  ACR_NAME: mlopsm          # Le nom de VOTRE ACR (√©tape 5.1)
  CONTAINER_APP_NAME: bank-churn  # Le nom de VOTRE Container App (√©tape 5.2)
  IMAGE_NAME: bank-churn-api

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=term

  build-and-deploy:
    needs: test  # Ne s'ex√©cute QUE si les tests r√©ussissent
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Ne d√©ploie que depuis 'main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # Utilise le secret format√©
      - name: Login to Azure Container Registry (ACR)
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Build and push Docker image
        run: |
          # Construit l'image et la tagge avec le hash unique du commit
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          # Cr√©e aussi un tag 'latest' pour r√©f√©rence
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          # Pousse les deux images vers l'ACR
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          echo "‚úÖ Images pouss√©es dans ACR."
      - name: Deploy to Azure Container Apps
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az containerapp update \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
            echo "‚úÖ Commande de d√©ploiement envoy√©e √† Azure."
      - name: Verify deployment
        run: |
          # R√©cup√®re l'URL publique de l'application
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "üåê Votre API est d√©ploy√©e √† l'adresse : https://$APP_URL"
          echo "ü©∫ Attente du d√©marrage (20s) et v√©rification..."
          sleep 20
          # Teste le endpoint /health
          curl -f https://$APP_URL/health || exit 1
          echo "‚úÖ D√©ploiement v√©rifi√© et r√©ussi !"